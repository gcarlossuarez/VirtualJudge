<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìä Dashboard de Actividad - Tiempo Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .refresh-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select, button {
            padding: 8px 15px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        select {
            background: white;
            color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            font-weight: bold;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 14px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 42px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-subtitle {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .activity-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-list {
            display: grid;
            gap: 15px;
        }

        .activity-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .activity-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .activity-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .activity-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: white;
        }

        .activity-details h3 {
            font-size: 16px;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .activity-details p {
            font-size: 12px;
            color: #64748b;
        }

        .activity-stats {
            text-align: right;
        }

        .activity-count {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .activity-time {
            font-size: 11px;
            color: #94a3b8;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
        }

        .error {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            padding: 15px 20px;
            border-radius: 10px;
            color: #991b1b;
            margin-bottom: 20px;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }

            .activity-item {
                flex-direction: column;
                text-align: center;
            }

            .activity-stats {
                text-align: center;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>üìä</span>
                Dashboard de Actividad
            </h1>
            <div class="refresh-info">
                <div class="status-indicator"></div>
                <span id="lastUpdate">Cargando...</span>
                <div class="controls">
                    <select id="periodSelect">
                        <option value="1">√öltimas 24h</option>
                        <option value="7" selected>√öltimos 7 d√≠as</option>
                        <option value="30">√öltimos 30 d√≠as</option>
                        <option value="90">√öltimos 90 d√≠as</option>
                    </select>
                    <button onclick="loadStats()">üîÑ Actualizar</button>
                </div>
            </div>
        </header>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Total Actividades</div>
                <div class="stat-value" id="totalActivities">-</div>
                <div class="stat-subtitle" id="periodText">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Estudiantes √önicos</div>
                <div class="stat-value" id="uniqueStudents">-</div>
                <div class="stat-subtitle">Usuarios activos</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Tipo m√°s Frecuente</div>
                <div class="stat-value" id="topActivity" style="font-size: 24px;">-</div>
                <div class="stat-subtitle" id="topCount">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Promedio por Usuario</div>
                <div class="stat-value" id="avgPerUser">-</div>
                <div class="stat-subtitle">Actividades/estudiante</div>
            </div>
        </div>

        <div class="activity-section">
            <div class="section-title">
                <span>üìà</span>
                Actividad por Tipo
            </div>
            <div id="errorContainer"></div>
            <div id="activityList" class="activity-list">
                <div class="loading">‚è≥ Cargando datos...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/admin/activity-stats';
        let refreshInterval;

        // Mapeo de iconos y nombres para cada tipo de actividad
        const ACTIVITY_CONFIG = {
            'ContestLoaded': { icon: 'üèÜ', name: 'Contest Cargado', color: '#3b82f6' },
            'ProblemViewed': { icon: 'üëÅÔ∏è', name: 'Problema Visto', color: '#8b5cf6' },
            'SubmissionSent': { icon: 'üì§', name: 'C√≥digo Enviado', color: '#10b981' },
            'LocalValidation': { icon: '‚úÖ', name: 'Validaci√≥n Local', color: '#f59e0b' },
            'DatasetSynced': { icon: 'üîÑ', name: 'Dataset Sincronizado', color: '#06b6d4' },
            'SdkDownloaded': { icon: '‚¨áÔ∏è', name: 'SDK Descargado', color: '#6366f1' },
            'ContestCreated': { icon: '‚ûï', name: 'Contest Creado', color: '#ec4899' },
            'ContestEdited': { icon: '‚úèÔ∏è', name: 'Contest Editado', color: '#f97316' },
            'StudentAdded': { icon: 'üë§', name: 'Estudiante Agregado', color: '#14b8a6' },
            'StudentRemoved': { icon: '‚ùå', name: 'Estudiante Eliminado', color: '#ef4444' },
            'StudentLogin': { icon: 'üîê', name: 'Entrada al Juez', color: '#0ea5e9' }
        };

        function formatTime(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Hace unos segundos';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            if (diffHours < 24) return `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
            return `Hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
        }

        async function loadStats() {
            const days = document.getElementById('periodSelect').value;
            const errorContainer = document.getElementById('errorContainer');
            const activityList = document.getElementById('activityList');

            try {
                activityList.innerHTML = '<div class="loading">‚è≥ Cargando datos...</div>';
                errorContainer.innerHTML = '';

                const response = await fetch(`${API_URL}?days=${days}`);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Actualizar stats principales
                document.getElementById('totalActivities').textContent = data.totalActivities.toLocaleString();
                document.getElementById('uniqueStudents').textContent = data.uniqueStudents.toLocaleString();
                document.getElementById('periodText').textContent = data.period;

                // Calcular promedio
                const avg = data.uniqueStudents > 0 
                    ? (data.totalActivities / data.uniqueStudents).toFixed(1)
                    : '0';
                document.getElementById('avgPerUser').textContent = avg;

                // Actividad m√°s frecuente
                if (data.activityByType && data.activityByType.length > 0) {
                    const top = data.activityByType[0];
                    const config = ACTIVITY_CONFIG[top.action] || { icon: 'üìä', name: top.action };
                    document.getElementById('topActivity').textContent = config.icon + ' ' + config.name;
                    document.getElementById('topCount').textContent = `${top.count.toLocaleString()} eventos`;
                } else {
                    document.getElementById('topActivity').textContent = '‚Äî';
                    document.getElementById('topCount').textContent = 'Sin datos';
                }

                // Renderizar lista de actividades
                if (data.activityByType && data.activityByType.length > 0) {
                    activityList.innerHTML = data.activityByType.map(activity => {
                        const config = ACTIVITY_CONFIG[activity.action] || { 
                            icon: 'üìä', 
                            name: activity.action,
                            color: '#667eea'
                        };

                        return `
                            <div class="activity-item">
                                <div class="activity-info">
                                    <div class="activity-icon" style="background: ${config.color}20; color: ${config.color};">
                                        ${config.icon}
                                    </div>
                                    <div class="activity-details">
                                        <h3>${config.name}</h3>
                                        <p>ID: ${activity.actionId}</p>
                                    </div>
                                </div>
                                <div class="activity-stats">
                                    <div class="activity-count">${activity.count.toLocaleString()}</div>
                                    <div class="activity-time">${formatTime(activity.lastActivity)}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    activityList.innerHTML = `
                        <div class="empty">
                            <div class="empty-icon">üì≠</div>
                            <p>No hay actividad registrada en este per√≠odo</p>
                        </div>
                    `;
                }

                // Actualizar timestamp
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `Actualizado: ${now.toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                errorContainer.innerHTML = `
                    <div class="error">
                        <strong>‚ö†Ô∏è Error al cargar datos:</strong><br>
                        ${error.message}
                    </div>
                `;
                activityList.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">‚ùå</div>
                        <p>No se pudieron cargar los datos. Verifica que el servidor est√© corriendo.</p>
                    </div>
                `;
            }
        }

        // Cargar al inicio
        loadStats();

        // Auto-refresh cada 10 segundos
        refreshInterval = setInterval(loadStats, 10000);

        // Cambiar per√≠odo
        document.getElementById('periodSelect').addEventListener('change', loadStats);

        // Limpiar interval al cerrar
        window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
        });
    </script>
</body>
</html>
